<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>| Dashboard</title>
    <link rel="stylesheet" href="./Styles/dash.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>
  </head>

  <body>
    <div class="div-marquee">
    <marquee>⚠️ ALERTA: Compressor A atingiu o limite de umidade!</marquee>
    </div>  
    <div class="kpiData">Última Atualização: <span id="dataHora"></span></div>
    <div class="container-pai">
      <div class="sidebar">
        <div class="profile">
          <img src="./Imgs/account.png" alt="Perfil" />

          <h1>Olá, Brandão!</h1>
        </div>

        <a href="./dashboard.html">Visão Geral</a>
        <a href="./detalhes.html">Visão Detalhada</a>
        <a href="./cadastro-dryflow.html">Cadastrar Novo Usúario</a>

        <a href="../DryFlow/dryflow-index.html" class="logout-btn">
          Sign-out
          <img src="./Imgs/logout.png" alt="Logout" class="logout-icon" />
        </a>
      </div>

     
      <div class="graficos">
        <div class="info-limites">
          <div class="card">
            <div class="primeira">.</div>
            <h4 >Próximo ao Limite de Umidade</h4>
            <span >Entre 45% e 49%</span>
          </div>
          <div class="card">
            <div class="segunda">.</div>
            <h4 >Limite de Umidade</h4>
            <span>50%</span>
          </div>
          <div class="card">
            <div class="terceira">.</div>
            <h4 >Acima do Limite de Umidade</h4>
            <span>Maior que 50%</span>
          </div>
        </div>
        <!-- KPIs -->
        <div class="kpis-container">
          <div class="card1">
            <p>
              Compressores perto do limite de umidade:<br /><br /><span id="kpi-perto">0</span>
            </p>
          </div>
          <div class="card2">
            <p>
              Compressores dentro do limite de umidade:<br /><br /><span id="kpi-no-limite">0</span>
            </p>
          </div>
          <div class="card3">
            <p>
              Compressores acima do limite de umidade:<br /><br /><span id="kpi-acima">0</span>
            </p>
          </div>
        </div>
      
        <!-- Gráficos -->
        <div class="graficoBarra">
          <h4>Umidade Atual dos Compressores</h4>
          <div class="charts">
            <canvas id="myChart"></canvas>
          </div>
        </div>
        <div class="graficoLine">
          <h4>Umidade dos Compressores por Dia</h4>
          <div class="charts">
            <canvas id="myChart2"></canvas>
          </div>
        </div>
      
      </div>
      
    </div>

    <script>
      function atualizarDataHora() {
        const agora = new Date();
        const dataHoraFormatada = agora.toLocaleString("pt-BR"); // horario e data brasileiros
        document.getElementById("dataHora").textContent = dataHoraFormatada;
      }

      // Atualiza a hora quanto recarrega a pagina
      atualizarDataHora();
    </script>
    <script>
      function atualizarKPIsBarra(datasets, limite = 50) {
        let perto = 0;
        let noLimite = 0;
        let acima = 0;

        const dados = datasets[0].data;

        dados.forEach((valor) => {
          if (valor > limite) {
            acima++;
          } else if (valor <= limite && valor < limite - 5) {
            noLimite++;
          } else if (valor >= limite - 5 && valor <= limite) {
            perto++;
          }
        });

        document.getElementById("kpi-perto").textContent = perto;
        document.getElementById("kpi-no-limite").textContent = noLimite;
        document.getElementById("kpi-acima").textContent = acima;
      }
    </script>

    <script>
      const umidadeAtual = [
        {
          label: "Umidade Atual",
          data: [80, 84, 57, 43],
          backgroundColor: "#89bfff",
          borderWidth: 1,
        },
      ];

      const ctx = document.getElementById("myChart").getContext("2d");
      Chart.register(window["chartjs-plugin-annotation"]);

      const graficoBar = new Chart(ctx, {
        type: "bar",
        data: {
          labels: [
            "Compressor A",
            "Compressor B",
            "Compressor C",
            "Compressor D",
          ],
          datasets: umidadeAtual,
        },
        options: {
          responsive: true,
          plugins: {
            annotation: {
              annotations: {
                umidadeIdeal: {
                  type: "line",
                  yMin: 50,
                  yMax: 50,
                  borderColor: " #ff0000",
                  borderWidth: 2,
                  borderDash: [6, 4],
                  label: {
                    content: "Limite",
                    enabled: true,

                    backgroundColor: " #ff0000",
                    color: "white",
                    position: "end",
                    font: {
                      size: 9,
                      
                    },
                  },
                },
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Umidade %",
                color: '0c1326',
                font:{
                  weight: 500,
                }
              },
            },
            x: {
              title: {
                display: true,
                text: "Compressor",
                color: '0c1326',
                font:{
                  weight: 500,

                }
              },
            },
          },
        },
      });
      atualizarKPIsBarra(graficoBar.data.datasets);
    </script>

    <script>
      const grafico = document.getElementById("myChart2");

      const todosDados = [
        {
          label: "Compressor A",
          data: [80, 82, 80, 85, 80, 88],
          backgroundColor: "#89bfff",
          borderWidth: 2,
          borderColor: "#89bfff",
        },
        {
          label: "Compressor B",
          data: [90, 89, 93, 87, 88, 82],
          backgroundColor: "#003161",
          borderWidth: 2,
          borderColor: "#003161",
        },
        {
          label: "Compressor C",
          data: [60, 70, 80, 85, 90, 90],
          backgroundColor: "#262626",
          borderWidth: 2,
          borderColor: "#262626",
        },
        {
          label: "Compressor D",
          data: [30, 33, 35, 29, 31, 34],
          backgroundColor: "#006A67",
          borderWidth: 2,
          borderColor: "#006A67",
        },
      ];
      Chart.register(window["chartjs-plugin-annotation"]);

      const chartLinha = new Chart(grafico, {
        type: "line",
        data: {
          labels: ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"],
          datasets: todosDados,
        },
        options: {
          responsive: true,
          plugins: {
            annotation: {
              annotations: {
                umidadeIdeal: {
                  type: "line",
                  yMin: 50,
                  yMax: 50,
                  borderColor: " #ff0000",
                  borderWidth: 2,
                  borderDash: [6, 4],
                  label: {
                    content: "Limite",
                    enabled: true,

                    backgroundColor: " #ff0000",
                    color: "white",
                    position: "end",
                    font: {
                      size: 9,
                    },
                  },
                },
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Umidade %",
                color: '0c1326',
                font:{
                  weight: 500,
                }
              },
            },
            x: {
              title: {
                display: true,
                color: '0c1326',
                text: "Dia da Semana",
                font:{
                  weight: 500,
                }
              },
            },
          },
        },
      });
      document
        .querySelectorAll('input[type="checkbox"]')
        .forEach((checkbox) => {
          checkbox.addEventListener("change", () => {
            const selecionados = Array.from(
              document.querySelectorAll('input[type="checkbox"]:checked')
            ).map((cb) => cb.value);

            chartLinha.data.datasets = todosDados.filter((ds) =>
              selecionados.includes(ds.label)
            );
            chartLinha.update();
          });
        });
    </script>
  </body>
</html>
